# 项目更新日志 (2025-12-05)

## 🌟 核心特性：智能目标追回机制 (Target Recovery)

针对 DeepSort 在复杂场景下可能出现的 **ID 跳变 (ID Switch)** 或 **ID 丢失** 问题，本项目引入了基于 IoU (交并比) 的位置接力机制，实现了“一旦锁定，咬死不放”的跟踪效果。

### 工作原理
1.  **历史位置记忆**：系统会实时记录当前锁定目标在上一帧的坐标 (`last_locked_bbox`)。
2.  **ID 丢失检测**：在每一帧推理时，首先检查当前锁定的 `track_id` 是否存在于 DeepSort 的输出列表中。
3.  **IoU 接力匹配**：
    *   如果锁定的 ID 突然消失（例如从 ID:5 变为 ID:8），系统不会立即丢失目标。
    *   算法计算 **上一帧目标框** 与 **当前帧所有新检测框** 的 IoU。
    *   **判定标准**：如果发现某个新 ID 的框与上一帧目标框的重叠度 (IoU) 超过阈值 (0.3)，系统判定为同一目标。
4.  **自动切换锁定**：系统自动将 `locked_track_id` 更新为这个新 ID，实现无缝衔接，舵机跟踪不会中断。

---

## 🚀 性能与架构优化

### 1. 前后端分离渲染 (Client-side Rendering)
*   **旧方案**：后端使用 OpenCV 在图片上绘制矩形框 -> 编码 JPEG -> 传输。导致 CPU 占用高，带宽浪费。
*   **新方案**：后端只推流纯净视频 (MJPEG) + JSON 坐标接口。前端使用 HTML5 Canvas 覆盖在视频上方绘制虚线框。
*   **收益**：显著降低了 Atlas 200 DK 的 CPU 负载，视频流更加流畅，前端样式（颜色、虚线）可随意定制。

### 2. 代码架构重构
为了解决 Flask 线程与 AI 推理线程的数据竞争问题，项目结构重构为三个模块：
*   `main.py`: 负责 AI 推理 (YOLO + DeepSort)、串口通信、摄像头采集。
*   `web_server.py`: 负责 Flask Web 服务、视频推流、API 响应。
*   `shared_state.py`: **[新增]** 专门管理跨线程共享变量（帧缓冲区、锁、交互状态），消除循环引用。

### 3. 视频流优化
*   分辨率调整为 **720P (1280x720)**，平衡清晰度与推理速度。
*   MJPEG 压缩质量设置为 **60**，大幅降低网络带宽占用。
*   推流帧率限制，防止浏览器端积压延迟。

---

## 🎮 交互逻辑更新

### "所见即所得" 的框选跟踪
1.  **默认状态**：画面干净，不显示任何检测框。
2.  **框选触发**：用户在前端画面画框 (ROI)。
3.  **瞬时判定**：
    *   系统在接下来的 **2帧** 内检测框选区域。
    *   **命中**：如果区域内有人脸，立即锁定该 ID，框变绿并开始跟踪。
    *   **未命中**：如果区域内无人，立即清除 ROI，不进行误触发。
4.  **状态清除**：当人脸消失或 DeepSort 无输出时，前端绘制层会自动清空，避免“鬼影框”残留。

---

## 🛠️ 部署说明
推荐使用 Systemd 服务化部署，确保开机自启与崩溃重启。
```bash
# 启动服务
sudo systemctl start face_track.service